{% extends 'index.html' %}

{% block content %}

{% if error %}
<div class="flex justify-center items-center min-h-[70vh] px-4">
  <div class="relative max-w-xl mx-auto mt-10 px-6 py-5 rounded-xl bg-red-500/20 border border-red-500/40 text-white text-center overflow-hidden shadow-lg">
    <div class="absolute inset-0 bg-red-500/30 blur-xl animate-pulse z-0"></div>
  
    <div class="relative z-10">
      <h3 class="text-lg font-semibold mb-2">⚠️ {{ error }}</h3>
      <p class="text-sm text-red-100">Impossible d'afficher vos tops Spotify.</p>
  
      <a href="{{ login_url }}"
         class="inline-flex items-center gap-2 mt-4 bg-white hover:bg-gray-300 text-black font-medium py-2 px-4 rounded transition">
        Se connecter avec Spotify
      </a>
    </div>
  </div>
</div>



{% else %}
<div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-10 px-4">
    <!-- Texte à gauche -->
    <div class="text-center md:text-left">
      <h2 class="text-3xl font-bold mb-1 text-center">Top Tracks</h2>
      <p class="text-gray-400 text-center">Your top tracks from the past 4 weeks</p>
    </div>
  
    <!-- Dropdown à droite -->
    <div class="absolute w-full flex justify-end max-w-6xl">
      <button id="dropdownButton" class="bg-gray-800 text-white px-4 py-2 rounded inline-flex items-center">
        Time Field
        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" stroke-width="2"
          viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
  
      <ul id="dropdownMenu" class="hidden absolute right-0 mt-2 bg-white text-black rounded shadow w-48 z-50">
        <li><a href="{{ url_for('get_tops', top_tracks_time_range='short_term', top_artists_time_range='short_term') }}" class="block px-4 py-2 hover:bg-gray-200">4 weeks</a></li>
        <li><a href="{{ url_for('get_tops', top_tracks_time_range='medium_term', top_artists_time_range='medium_term') }}" class="block px-4 py-2 hover:bg-gray-200">6 months</a></li>
        <li><a href="{{ url_for('get_tops', top_tracks_time_range='long_term', top_artists_time_range='long_term') }}" class="block px-4 py-2 hover:bg-gray-200">1 year</a></li>
      </ul>
    </div>
  </div>
  

{# --- Carrousel Top Tracks --- #}
{% if topTracks %}
<div class="relative glide my-10 w-full flex justify-center" id="glideTopTracks">
    <div class="glide__track max-w-6xl relative" data-glide-el="track">
        <ul class="glide__slides gap-x-2">
        {% for trackGroup in topTracks %}
          {% for track in trackGroup %}
            {% if track.album %}
            <li class="glide__slide">
              <div class="trackCard">
                <img src="{{ track['album']['images'][0]['url'] }}" alt="{{ track['name'] }}">
                <div class="title">{{ track['place'] }}. {{ track['name'] }}</div>
                <div class="subtitle-small">{{ track['artists'][0]['name'] }}</div>
              </div>
            </li>
            {% endif %}
          {% endfor %}
        {% endfor %}
        </ul>

        <div class="absolute h-full top-0 left-0 flex items-center z-10" data-glide-el="controls">
            <button class="glide__arrow glide__arrow--left bg-black/50 hover:bg-black/70 text-white w-10 h-10 px-3 py-2 rounded-full ml-2" data-glide-dir="<">
            ‹
            </button>
        </div>
        <div class="absolute h-full top-0 right-0 flex items-center z-10" data-glide-el="controls">
            <button class="glide__arrow glide__arrow--right bg-black/50 hover:bg-black/70 text-white w-10 h-10 px-3 py-2 rounded-full mr-2" data-glide-dir=">">
            ›
            </button>
        </div>
        
    </div>
</div>
{% endif %}


{# --- Carrousel Top Artists --- #}
{% if topArtists %}
<h2 class="mt-10 text-3xl font-bold text-center">Top Artists</h2>
<p class="subtitle text-center text-gray-400 mb-6">Your top artists from the past 4 weeks</p>

<div class="relative glide w-full flex justify-center" id="glideTopArtists">
    <div class="glide__track max-w-6xl relative" data-glide-el="track">
        <ul class="glide__slides gap-x-2">
        {% for artistGroup in topArtists %}
            {% for artist in artistGroup %}
            <li class="glide__slide">
                <div class="artistCard text-center">
                    {% if artist['images']|length > 0 %}
                    <img src="{{ artist['images'][0]['url'] }}" alt="{{ artist['name'] }}" class="rounded-full w-36 h-36 object-cover mx-auto mb-2">
                    {% else %}
                    <img src="" alt="{{ artist['name'] }}" class="rounded-full w-36 h-36 object-cover mx-auto mb-2">
                    {% endif %}
                    <div class="title text-white font-semibold">{{ artist['place'] }}. {{ artist['name'] }}</div>
                    <div class="subtitle-small text-sm text-gray-400">{{ artist['genres']|join(', ') }}</div>
                </div>
            </li>
            {% endfor %}
        {% endfor %}
        </ul>

        <!-- Arrows -->
        <div class="absolute h-full top-0 left-0 flex items-center z-10" data-glide-el="controls">
            <button class="glide__arrow glide__arrow--left bg-black/50 hover:bg-black/70 text-white w-10 h-10 px-3 py-2 rounded-full ml-2" data-glide-dir="<">
            ‹
            </button>
        </div>
        <div class="absolute h-full top-0 right-0 flex items-center z-10" data-glide-el="controls">
            <button class="glide__arrow glide__arrow--right bg-black/50 hover:bg-black/70 text-white w-10 h-10 px-3 py-2 rounded-full mr-2" data-glide-dir=">">
            ›
            </button>
        </div>
    </div>
</div>
{% endif %}


{# --- Recently Played --- #}
{% if recently_played_tracks %}
<h2 class="mt-10 text-3xl font-bold text-center">Recent streams</h2>
<p class="subtitle text-center text-gray-400 mb-4">Your most recently played tracks</p>

<div class="flex flex-col gap-3 px-4 max-w-4xl mx-auto">
  {% for trackPlayed in recently_played_tracks %}
    {% if trackPlayed.track %}
    <div class="bg-zinc-800 rounded-md shadow p-2 flex items-center gap-3">
      <img src="{{ trackPlayed['track']['album']['images'][0]['url'] }}"
           alt="{{ trackPlayed['track']['name'] }}"
           class="w-16 h-16 object-cover rounded" />
      <div class="flex-1">
        <h3 class="text-sm font-medium text-white">{{ trackPlayed['track']['name'] }}</h3>
        {% set fromArtistsName = [] %}
        {% for artist in trackPlayed['track']['artists'] %}
          <p hidden>{{ fromArtistsName.append(artist['name']) }}</p>
        {% endfor %}
        <p class="text-gray-400 text-xs">
          {{ fromArtistsName|join(", ") }} &#x25CF {{ trackPlayed['track']['album']['name'] }}
        </p>
      </div>
    </div>
    {% endif %}
  {% endfor %}
</div>
{% endif %}

{% endif %}


<script>
    new Glide('#glideTopTracks', {
    type: 'carousel',
    perView: 6,
    gap: 12,
    breakpoints: {
      1024: { perView: 4 },
      768: { perView: 3 },
      480: { perView: 2 }
    }
  }).mount()

  new Glide('#glideTopArtists', {
    type: 'carousel',
    perView: 6,
    gap: 12,
    breakpoints: {
      1024: { perView: 4 },
      768: { perView: 3 },
      480: { perView: 2 }
    }
  }).mount()

  const dropdownBtn = document.getElementById('dropdownButton');
  const dropdownMenu = document.getElementById('dropdownMenu');

  dropdownBtn.addEventListener('click', () => {
    dropdownMenu.classList.toggle('hidden');
  });

  window.addEventListener('click', (e) => {
    if (!dropdownBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
      dropdownMenu.classList.add('hidden');
    }
  });
</script>
  

{% endblock %}
