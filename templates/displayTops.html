{% extends 'index.html' %}

{% block content %}

{% if error %}
<div class="flex justify-center items-center min-h-[70vh] px-4">
  <div class="relative max-w-xl mx-auto mt-10 px-6 py-5 rounded-xl bg-red-500/20 border border-red-500/40 text-center overflow-hidden shadow-lg">
    <div class="absolute inset-0 bg-red-500/30 blur-xl animate-pulse z-0"></div>
  
    <div class="relative z-10">
      <h3 class="text-lg font-semibold mb-2">⚠️ {{ error }}</h3>
      <p class="text-sm dark:text-red-100 text-gray-800">Impossible d'afficher vos tops Spotify.</p>
  
      <a href="{{ login_url }}"
         class="inline-flex items-center gap-2 mt-4 dark:bg-white bg-black dark:hover:bg-gray-300 hover:bg-gray-800 dark:text-black text-white font-medium py-2 px-4 rounded-xl transition">
        Se connecter avec Spotify
      </a>
    </div>
  </div>
</div>
{% else %}

<div class="flex min-h-screen mt-[-4rem]">
  <!-- Sidebar -->
  <!-- Burger button (visible seulement sur mobile) -->
   <div class="fixed top-0 left-0 mt-16 h-full px-2">
    <button id="menu-toggle" class="md:hidden z-50 p-2 rounded text-white">
      <img src="{{ url_for('static', filename='assets/app.png') }}" alt="" width="25" height="25" class="dark:invert">
    </button>
   </div>
  

  <!-- Sidebar -->
  <aside id="sidebar"
        class="fixed top-0 left-0 mt-16 h-full w-60 border-r dark:bg-[#0f0f0f] bg-white dark:border-zinc-700 border-gray-300 z-40 transform -translate-x-full md:translate-x-0 md:block transition-transform duration-300 ease-in-out">
    <div class="pt-3">
      <button class="block w-full text-left py-4 px-8 hover:bg-[--PRIMARY_COLOR] active dark:hover:text-black hover:text-white transition" data-section="tracks">Top Tracks</button>
      <button class="block w-full text-left py-4 px-8 hover:bg-[--PRIMARY_COLOR] dark:hover:text-black hover:text-white transition" data-section="artists">Top Artists</button>
      <button class="block w-full text-left py-4 px-8 hover:bg-[--PRIMARY_COLOR] dark:hover:text-black hover:text-white transition" data-section="recent">Recent Streams</button>
    </div>
  </aside>

  <!-- Overlay (clique pour fermer le menu mobile) -->
<div id="overlay"
class="fixed inset-0 dark:bg-[#0f0f0f]/50 bg-white/50 backdrop-blur z-30 hidden md:hidden"
aria-hidden="true"></div>

  <!-- Contenu principal -->
  <main class="md:ml-60 flex-1 overflow-y-auto p-8 space-y-16">
    <section id="section-tracks" class="section-content mt-16">
      {% set flat_tracks = topTracks | sum(start=[]) %}
      {% set podium_tracks = flat_tracks[0:3] %}
      {% set rest_tracks = flat_tracks[3:] %}

      {# --- Podium des 3 premiers tracks --- #}
      <div class="flex justify-center items-end lg:gap-32 md:gap-16 gap-8 px-4 max-w-5xl mx-auto">
        <!-- 2ème place -->
        <div class="relative flex flex-col items-center">
          <!-- Glow pulsé -->
          <div class="absolute inset-0 flex justify-center items-center -z-10">
            <div class="w-24 h-24 dark:bg-gray-400/50 bg-gray-800 blur-2xl rounded-lg animate-pulse"></div>
          </div>
          <img src="{{ podium_tracks[1]['album']['images'][0]['url'] }}"
              class="w-24 h-24 rounded-lg border-4 border-gray-400 mb-2 object-cover z-10" />
          <span class="truncate w-24 block text-center text-sm dark:text-gray-300 text-gray-800">{{ podium_tracks[1]['name'] }}</span>
          <span class="text-xs text-gray-500">#2</span>
        </div>

        <!-- 1ère place -->
        <div class="relative flex flex-col items-center transform translate-y-[-20px]">
          <!-- Glow pulsé -->
          <div class="absolute inset-0 flex justify-center items-center -z-10">
            <div class="w-28 h-28 dark:bg-yellow-400/50 bg-yellow-600 blur-2xl rounded-lg animate-pulse"></div>
          </div>
          <img src="{{ podium_tracks[0]['album']['images'][0]['url'] }}"
              class="w-28 h-28 rounded-lg border-4 border-yellow-400 mb-2 object-cover z-10" />
          <span class="truncate w-28 block text-center font-semibold">{{ podium_tracks[0]['name'] }}</span>
          <span class="text-sm text-yellow-500">#1</span>
        </div>

        <!-- 3ème place -->
        <div class="relative flex flex-col items-center">
          <!-- Glow pulsé -->
          <div class="absolute inset-0 flex justify-center items-center -z-10">
            <div class="w-24 h-24 dark:bg-orange-400/50 bg-orange-600 blur-2xl rounded-lg animate-pulse"></div>
          </div>
          <img src="{{ podium_tracks[2]['album']['images'][0]['url'] }}"
              class="w-24 h-24 rounded-lg border-4 border-orange-400 mb-2 object-cover z-10" />
          <span class="truncate w-24 block text-center text-sm dark:text-gray-300 text-gray-600">{{ podium_tracks[2]['name'] }}</span>
          <span class="text-xs text-gray-500">#3</span>
        </div>


      </div>

      {# --- Masonry des autres tracks --- #}
      <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 px-4 max-w-7xl mx-auto mt-10">
        {% for track in rest_tracks %}
          {% if track.album %}
          <div class="rounded-lg overflow-hidden dark:bg-zinc-900 bg-gray-200 border dark:border-zinc-700 border-gray-300 shadow-md hover:shadow-[--PRIMARY_COLOR]/30 transition duration-300 group">
            <img src="{{ track['album']['images'][0]['url'] }}"
                alt="{{ track['name'] }}"
                class="w-full h-auto object-cover aspect-square" />
            <div class="px-3 py-2">
              <div class=" font-medium text-sm leading-tight mb-1">
                {{ track['place'] }}. {{ track['name'] }}
              </div>
              <div class="dark:text-gray-400 text-gray-600 text-xs">
                {{ track['artists'][0]['name'] }}
              </div>
              {% if track['preview_url'] %}
              <audio controls class="w-full mt-2 rounded">
                <source src="{{ track['preview_url'] }}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>
              {% endif %}
            </div>
          </div>
          {% endif %}
        {% endfor %}
      </div>
      

    </section>
    <section id="section-artists" class="section-content hidden">
      
      <!-- Tops Artistes -->
      {# Aplatit topArtists (qui est une liste de listes) #}
      {% set flat_artists = topArtists | sum(start=[]) %}
      {% set podium = flat_artists[0:3] %}
      {% set rest = flat_artists[3:] %}

      {# --- Podium des 3 premiers artistes --- #}
      <div class="flex justify-center items-end lg:gap-24 md:gap-16 gap-8 mt-12">
        <!-- 2ème place -->
        {% if podium[1]['images'] %}
        <div class="relative flex flex-col items-center">
          <!-- Glow -->
          <div class="absolute inset-0 flex justify-center items-center -z-10">
            <div class="w-24 h-24 dark:bg-gray-400/50 bg-gray-800 blur-2xl rounded-full animate-pulse"></div>
          </div>
          <img src="{{ podium[1]['images'][0]['url'] }}" class="w-24 h-24 rounded-full border-4 border-gray-400 mb-2 z-10 object-cover" />
          <span class="dark:text-gray-300 text-gray-800 text-sm">{{ podium[1]['name'] }}</span>
          <span class="text-xs text-gray-500">#2</span>
        </div>
        {% endif %}

        <!-- 1ère place -->
        {% if podium[0]['images'] %}
        <div class="relative flex flex-col items-center transform translate-y-[-20px]">
          <!-- Glow -->
          <div class="absolute inset-0 flex justify-center items-center -z-10">
            <div class="w-32 h-32 dark:bg-yellow-400/50 bg-yellow-600 blur-2xl rounded-full animate-pulse"></div>
          </div>
          <img src="{{ podium[0]['images'][0]['url'] }}" class="w-32 h-32 rounded-full border-4 border-yellow-400 mb-2 z-10 object-cover" />
          <span class="text-white font-semibold">{{ podium[0]['name'] }}</span>
          <span class="text-sm text-yellow-500">#1</span>
        </div>
        {% endif %}

        <!-- 3ème place -->
        {% if podium[2]['images'] %}
        <div class="relative flex flex-col items-center">
          <!-- Glow -->
          <div class="absolute inset-0 flex justify-center items-center -z-10">
            <div class="w-24 h-24 dark:bg-orange-400/50 bg-orange-600 blur-2xl rounded-full animate-pulse"></div>
          </div>
          <img src="{{ podium[2]['images'][0]['url'] }}" class="w-24 h-24 rounded-full border-4 border-orange-400 mb-2 z-10 object-cover" />
          <span class="dark:text-gray-300 text-gray-600 text-sm">{{ podium[2]['name'] }}</span>
          <span class="text-xs text-gray-500">#3</span>
        </div>
        {% endif %}

      </div>

      {# --- Grid circulaire des autres artistes --- #}

      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6 px-4 max-w-6xl mx-auto mt-10">
        {% for artist in rest %}
          <div class="flex flex-col items-center text-center hover:scale-105 transition duration-300">
            {% if artist['images'] %}
            <img src="{{ artist['images'][0]['url'] }}"
                alt="{{ artist['name'] }}"
                class="w-24 h-24 rounded-full border border-zinc-700 shadow-sm object-cover mb-2" />
            {% endif %}
            <div class="font-medium text-sm">{{ artist['place'] }}. {{ artist['name'] }}</div>
            <div class="dark:text-gray-400 text-gray-600 text-xs">{{ artist['genres'] | join(', ') }}</div>
          </div>
        {% endfor %}
      </div>
    </section>
    <section id="section-recent" class="section-content hidden">
      <section class="max-w-3xl mx-auto my-16 px-4">
        <div class="relative border-l-2 border-gray-300 dark:border-zinc-600 pl-6 space-y-5">
          {% for trackPlayed in recently_played_tracks %}
            {% if trackPlayed.track %}
            <div class="relative group opacity-0 translate-y-4 transition-all duration-500 ease-out animate-fade-in-up scroll-animate">
              <div class="dark:bg-zinc-900 bg-gray-200 border dark:border-zinc-800 border-gray-300 rounded-xl p-4 shadow flex gap-4 items-center">
                <img src="{{ trackPlayed['track']['album']['images'][0]['url'] }}"
                    alt="{{ trackPlayed['track']['name'] }}"
                    class="w-16 h-16 object-cover rounded" />
                <div>
                  <h3 class=" text-sm font-semibold">{{ trackPlayed['track']['name'] }}</h3>
                  {% set fromArtistsName = [] %}
                  {% for artist in trackPlayed['track']['artists'] %}
                    <p hidden>{{ fromArtistsName.append(artist['name']) }}</p>
                  {% endfor %}
                  <p class="dark:text-gray-400 text-gray-800 text-xs">{{ fromArtistsName|join(", ") }}</p>
                  <p class="dark:text-gray-500 text-gray-600 text-xs mt-1">🕒 {{ trackPlayed['played_at'][:16].replace("T", " ") }}</p>
                </div>
              </div>
            </div>
            {% endif %}
          {% endfor %}
        </div>
      </section>

    </section>
  </main>
</div>





{% endif %}
{% endblock %}
